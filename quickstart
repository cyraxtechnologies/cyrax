#!/bin/bash
# Cyrax Quick Start Script
# Automates the setup process

set -e

echo "ü§ñ Cyrax Setup Script"
echo "===================="
echo ""

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

if [ "$EUID" -eq 0 ]; then 
    echo -e "${RED}Please do not run as root${NC}"
    exit 1
fi

echo -e "${GREEN}Step 1: Creating project structure...${NC}"
mkdir -p app/models app/routers app/services app/utils app/schemas tests migrations logs media
touch app/__init__.py app/models/__init__.py app/routers/__init__.py
touch app/services/__init__.py app/utils/__init__.py app/schemas/__init__.py
touch tests/__init__.py

echo -e "${GREEN}Step 2: Setting up Python virtual environment...${NC}"
python3 -m venv venv
source venv/bin/activate

echo -e "${GREEN}Step 3: Installing Python dependencies...${NC}"
pip install --upgrade pip
pip install -r requirements.txt

echo -e "${GREEN}Step 4: Setting up environment variables...${NC}"
if [ ! -f .env ]; then
    cp .env.example .env
    echo -e "${YELLOW}‚ö†Ô∏è  Please edit .env file with your API keys!${NC}"
    echo "   Required: WHATSAPP_ACCESS_TOKEN, OPENAI_API_KEY, PAYSTACK_SECRET_KEY"
    echo ""
    read -p "Press Enter to open .env in nano (or Ctrl+C to edit later)..."
    nano .env
else
    echo ".env file already exists, skipping..."
fi

echo -e "${GREEN}Step 5: Generating SECRET_KEY...${NC}"
SECRET_KEY=$(openssl rand -hex 32)
PIN_KEY=$(openssl rand -hex 32)
echo "SECRET_KEY=$SECRET_KEY" >> .env
echo "PIN_ENCRYPTION_KEY=$PIN_KEY" >> .env
echo "‚úÖ Security keys generated"

echo -e "${GREEN}Step 6: Checking database...${NC}"
read -p "Do you want to set up PostgreSQL now? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "Installing PostgreSQL..."
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        sudo apt update
        sudo apt install -y postgresql postgresql-contrib
        sudo systemctl start postgresql
        sudo systemctl enable postgresql
        
        sudo -u postgres psql -c "CREATE DATABASE cyrax_db;"
        sudo -u postgres psql -c "CREATE USER cyrax_user WITH PASSWORD 'cyrax_password_change_me';"
        sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE cyrax_db TO cyrax_user;"
        
        echo "‚úÖ PostgreSQL set up complete"
        echo "‚ö†Ô∏è  Remember to change the default password in production!"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        brew install postgresql@15
        brew services start postgresql@15
        createdb cyrax_db
        echo "‚úÖ PostgreSQL set up complete"
    fi
fi

echo -e "${GREEN}Step 7: Checking Redis...${NC}"
read -p "Do you want to install Redis now? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        sudo apt install -y redis-server
        sudo systemctl start redis-server
        sudo systemctl enable redis-server
        echo "‚úÖ Redis installed and started"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        brew install redis
        brew services start redis
        echo "‚úÖ Redis installed and started"
    fi
fi

echo -e "${GREEN}Step 8: Initializing database...${NC}"
python -c "from app.database import init_db; init_db()"
echo "‚úÖ Database tables created"

echo ""
echo "=========================================="
echo -e "${GREEN}‚úÖ Cyrax Setup Complete!${NC}"
echo "=========================================="
echo ""
echo "üìù Next Steps:"
echo ""
echo "1. Edit .env file with your API keys:"
echo "   - WhatsApp Business API credentials"
echo "   - OpenAI API key"
echo "   - PayStack API keys"
echo ""
echo "2. Start the application:"
echo "   source venv/bin/activate"
echo "   uvicorn app.main:app --reload"
echo ""
echo "3. Or use Docker:"
echo "   docker-compose up -d"
echo ""
echo "4. Set up ngrok for testing:"
echo "   ngrok http 8000"
echo ""
echo "5. Configure WhatsApp webhook with your ngrok URL"
echo ""
echo "üìö Full documentation: README.md"
echo ""
echo "Need help? Check out:"
echo "- GitHub: https://github.com/yourusername/cyrax"
echo ""
echo "Happy building with Cyrax! üöÄ"
